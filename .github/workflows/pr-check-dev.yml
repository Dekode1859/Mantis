name: Dev PR Checks

on:
  pull_request:
    branches: [develop]

jobs:
  validate:
    runs-on: self-hosted
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env.dev from GitHub secrets
        run: |
          cat > .env.dev << EOF
          # Database Configuration
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          # JWT Authentication Configuration
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM=${{ secrets.JWT_ALGORITHM }}
          JWT_EXPIRATION_MINUTES=${{ secrets.JWT_EXPIRATION_MINUTES }}

          # CORS Configuration
          CORS_ALLOW_ORIGINS=${{ secrets.CORS_ALLOW_ORIGINS }}

          # Email Verification (Resend)
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL=${{ secrets.RESEND_FROM_EMAIL }}

          # OTP Configuration
          OTP_EXPIRATION_MINUTES=${{ secrets.OTP_EXPIRATION_MINUTES }}
          EOF

      - name: Validate docker-compose syntax
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.dev config

      - name: Build test (no deployment)
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.dev build

      - name: Check .env.dev exists
        run: |
          test -f .env.dev || exit 1

      - name: Verify backend Dockerfile
        run: |
          test -f backend/Dockerfile || exit 1

      - name: Verify frontend Dockerfile
        run: |
          test -f mantis/Dockerfile || exit 1

      - name: Check disk space
        run: |
          df -h | grep -E 'Filesystem|/$'

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f .env.dev
