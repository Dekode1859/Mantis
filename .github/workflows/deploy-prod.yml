name: Deploy to Production

on:
  push:
    branches: [master]

jobs:
  deploy-production:
    runs-on: self-hosted
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mantis-repo

      - name: Copy code to /root/Mantis
        run: |
          # Sync code from runner workspace to /root/Mantis
          rsync -av --delete \
            --exclude='deployments/' \
            --exclude='.git/' \
            mantis-repo/ /root/Mantis/

          echo "âœ… Code synced to /root/Mantis"

      - name: Create .env.prod from GitHub secrets
        run: |
          cat > /root/Mantis/.env.prod << EOF
          # Database Configuration
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          # JWT Authentication Configuration
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM=${{ secrets.JWT_ALGORITHM }}
          JWT_EXPIRATION_MINUTES=${{ secrets.JWT_EXPIRATION_MINUTES }}

          # CORS Configuration
          CORS_ALLOW_ORIGIN_REGEX=${{ secrets.CORS_ALLOW_ORIGIN_REGEX }}

          # Email Verification (Resend)
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL=${{ secrets.RESEND_FROM_EMAIL }}

          # OTP Configuration
          OTP_EXPIRATION_MINUTES=${{ secrets.OTP_EXPIRATION_MINUTES }}

          # Cloudflare Tunnel Token
          CLOUDFLARE_TUNNEL_TOKEN=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          EOF

      - name: Create pre-deployment backup
        run: |
          cd /root/Mantis
          ./scripts/backup-prod.sh
          echo "âœ… Pre-deployment backup created"

      - name: Stop existing prod containers (to avoid conflicts)
        run: |
          cd /root/Mantis

          # First try docker compose down
          docker compose -f docker-compose.prod.yml --env-file .env.prod down --remove-orphans || true

          # Force remove any lingering mantis-prod containers (especially tunnel)
          docker ps -a --filter "name=mantis-prod-" --format "{{.Names}}" | xargs -r docker rm -f || true

          echo "âœ… All existing prod containers removed"

      - name: Build new production containers
        run: |
          cd /root/Mantis
          docker compose -f docker-compose.prod.yml --env-file .env.prod build

      - name: Deploy with zero downtime
        run: |
          cd /root/Mantis
          # Start new containers (will replace old ones)
          docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

      - name: Wait for services to initialize
        run: sleep 15

      - name: Verify backend health
        run: |
          curl -f http://localhost:8001/health || exit 1

      - name: Verify database connectivity
        run: |
          docker exec mantis-prod-db psql -U mantis_user -d mantis_production -c "\dt"

      - name: Verify tunnel is running
        run: |
          docker ps | grep mantis-prod-tunnel || exit 1

      - name: Cleanup old Docker images
        run: |
          docker image prune -f

      - name: Deployment summary
        run: |
          echo "ðŸš€ Production deployment successful"
          echo "ðŸŒ Live at: https://mantis.dekode.live"
          echo "ðŸ“Š Commit: ${{ github.sha }}"
          echo ""
          echo "ðŸ“¦ Running containers:"
          docker ps --filter "name=mantis-prod-" --format "table {{.Names}}\t{{.Status}}"

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f /root/Mantis/.env.prod
